### t_order
alter table `t_order`
modify column `order_type`  tinyint(1) not null comment '1: 采购订单; 2: 销售订单' after `refund_num`,
modify column `contactee`  varchar(64) character SET utf8 collate utf8_general_ci null default '' comment '联系人' after `sale_port`,
add column `is_direct`  tinyint(1) not null default 2 comment '是否直签，1-直签，2-非直签（即魔方)' after `agent_flag`,
add column `online_pay`  tinyint(1) not null default 1 comment '直签是否需要线上支付，1是，0否，默认1' after `is_direct`,
add column  `is_dock` tinyint(4) default '0' comment '是否对接商品. 0: 否; 1: 是'  after `online_pay`;

### t_order_merch
alter table `t_order_merch`
add column `start_time`  timestamp not null after `check_time`,
add column `expire_time`  timestamp not null after `start_time`;

### t_order_merch
update t_order_merch m,t_voucher_base v set m.start_time=v.start_time,m.expire_time=v.expire_time where m.voucher_id=v.voucher_id;

alter table `t_voucher_base`
modify column `voucher_content_type`  int(10) not null comment '1 联系人手机号 2 魔方码、二维码 3 身份证号' after `voucher_content`;
 
alter table `t_voucher_base`
modify column `contact_name`  varchar(64) character SET utf8 collate utf8_general_ci null default null comment '姓名';

update t_voucher_base set voucher_content_type=4 where voucher_content_type=3;
update t_voucher_base set voucher_content_type=3 where voucher_content_type=1;
update t_voucher_base set voucher_content_type=1 where voucher_content_type=4;


####t_merch_clean_relation#####
alter table `t_merch_clean_relation`
add column `is_minus_clean`  tinyint(1) not null default '0' comment '是否是为负数的结算单 0否（默认）1是，强制退款生成',
add column `normal_clean_num`  int(9)  default null comment '正常清算数量',
add column `overdue_clean_num`  int(9)  default null comment '逾期清算数量',
add column `refund_clean_num`  int(9) default null comment '退款清算数量',

add column `normal_clean_amount`  double(12,4) default null comment '正常结算金额',
add column `overdue_clean_amount`  double(12,4) default null comment '逾期结算金额',
add column `refund_clean_amount`  double(12,4) default null comment '退款结算金额',
modify column `clean_type` tinyint(1) NOT NULL DEFAULT '1' COMMENT '清算类别. 1: 正常清算; 2: 强制退款清算，3 订单未支付清算';

###save emoji
ALTER TABLE  t_order_remarks   MODIFY COLUMN   remark  VARCHAR(800) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci     DEFAULT NULL COMMENT '订单描述';
character-set-server=utf8mb4;

#t_refund_apply
DROP TABLE IF EXISTS `t_refund_apply`;
CREATE TABLE `t_refund_apply` (
  `apply_id` bigint(20) unsigned NOT NULL COMMENT '申请信息表ID',
  `refund_id` varchar(32) NOT NULL COMMENT '退款ID',
  `applier_id` bigint(20) unsigned NOT NULL COMMENT '退款申请人ID',
  `init_party` tinyint(1) unsigned NOT NULL COMMENT '退款发起方(1,用户发起;2, 平台发起;3, 对接拒绝)',
  `is_party` tinyint(1) unsigned NOT NULL COMMENT '部分退款(0,整单退;1,部分退)',
  `is_force` tinyint(1) unsigned NOT NULL COMMENT '强制退款(0,普通退;1,强制退)',
  `refund_state` tinyint(1) unsigned NOT NULL COMMENT '退款状态(1,退款中;2,成功;3,失败)',
  `refund_audit_state` tinyint(1) unsigned NOT NULL COMMENT '退款审核状态(1,平台待审核;2,财务待审核;8,对接审核中;9,审核完毕;7,拒绝退款)',
  PRIMARY KEY (`apply_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='退款申请基础表';

#主键自增
ALTER TABLE `t_refund_apply`
MODIFY COLUMN `apply_id`  bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '申请信息表ID' FIRST ;
#退款ID唯一索引
ADD UNIQUE INDEX `refund_id` (`refund_id`) USING HASH COMMENT '退款ID唯一索引';

#线上退款中订单,默认插入退款申请
insert into t_refund_apply(refund_id,applier_id,init_party,is_party,is_force,refund_state,refund_audit_state) 
SELECT t.refund_id , 1000000000000 as applier_id ,1 as init_party,0 as is_party,0 as is_force,1 as refund_state,9 as refund_audit_state from (SELECT DISTINCT  refund_id  from t_order_merchrefund_flow where refund_state=1) t;

#新增退款申请创建时间和更新时间
ALTER TABLE `t_refund_apply`
ADD COLUMN `create_time`  timestamp NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '创建时间' AFTER `refund_audit_state`,
ADD COLUMN `update_time`  timestamp  NULL COMMENT '更新时间' AFTER `create_time`;

#退款申请附加信息表
DROP TABLE IF EXISTS `t_refund_apply_info`;
CREATE TABLE `t_refund_apply_info` (
  `info_id` bigint(20) unsigned NOT NULL COMMENT '信息表ID',
  `refund_id` varchar(32) NOT NULL COMMENT '退款ID',
  `reason` varchar(255) NOT NULL COMMENT '退款原因',
  `img_src` varchar(255) DEFAULT NULL COMMENT '图片路径',
  PRIMARY KEY (`info_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='退款申请附加信息表';

#退款申请操作日志表
DROP TABLE IF EXISTS `t_refund_oper_log`;
CREATE TABLE `t_refund_oper_log` (
  `log_id` bigint(20) unsigned NOT NULL COMMENT '主键',
  `refund_id` varchar(32) NOT NULL COMMENT '退款ID',
  `operator_id` bigint(20) unsigned NOT NULL COMMENT '操作人ID',
  `prev` smallint(6) unsigned NOT NULL COMMENT '前置状态',
  `later` smallint(6) unsigned NOT NULL COMMENT '现状态',
  `action` smallint(6) unsigned NOT NULL COMMENT '来源（1普通用户,2支撑平台,3财务,4交易系统）',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`log_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='退款审核日志';

#新增退款规则类型
ALTER TABLE `t_order_merchrefund_flow`
ADD COLUMN `refund_rule_type`  tinyint(1) UNSIGNED NOT NULL DEFAULT 0 COMMENT '退款规则类型（0,未使用规则;1,时间点前规则;2,时间点后规则）' AFTER `update_time`;


####更新订单is_dock 列值
#stage环境
#注注意意,若预发布环境清空了订单表,此sql无需执行
update t_order set is_dock = 1 where transaction_id in 
(

	SELECT DISTINCT transaction_id FROM `t_order_merch` WHERE `product_id` in 
	('2216619736664003','2216619736663733','2216619736663732','2216619736663957','2216619736663958','2216619736663956',
	'2216619736663960','2216619736664003','2216619736664002','2216619736664002','2216619736664000','2216619736664000',
	'2216619736663998','2216619736663998','2216619736663997','2216619736663997','2216619736663994','2216619736663994',
	'2216619736663993','2216619736663993','2216619736663991','2216619736664015','2216619736664015','2216619736664014',
	'2216619736664014','2216619736664013','2216619736664011','2216619736664011','2216619736664006','2216619736664006',
	'2216619736664005','2216619736664005','2216619736664050','2216619736664050','2216619736664049','2216619736664049',
	'2216619736664048','2216619736664048','2216619736664047','2216619736664047','2216619736664046','2216619736664046',
	'2216619736664045','2216619736664045','2216619736664051','2216619736664051','2216619736663984','2216619736663985',
	'2216619736664148','2216619736664158','2216619736664162','2216619736664163','2216619736664164','2216619736664168',
	'2216619736664169','2216619736664167','2216619736664165','2216619736664171','2216619736664170','2216619736664170',
	'2216619736664149','2216619736664150','2216619736664151','2216619736664152','2216619736664153','2216619736664154',
	'2216619736664184','2216619736664185','2216619736664166','2216619736664166','2216619736663999','2216619736663996',
	'2216619736664213','2216619736664208','2216619736664209','2216619736664226','2216619736664227','2216619736664217',
	'2216619736664216','2216619736664206','2216619736664207','2216619736664204','2216619736664203','2216619736664215',
	'2216619736664218','2216619736664224','2216619736664225','2216619736664267','2216619736664228','2216619736664297',
	'2216619736664280','2216619736664278','2216619736664281','2216619736664279','2216619736664285','2216619736664274',
	'2216619736664286','2216619736664273','2216619736664271','2216619736664288','2216619736664287','2216619736664275',
	'2216619736664284','2216619736664291','2216619736664292','2216619736664293','2216619736664289','2216619736664294',
	'2216619736664290','2216619736664272','2216619736664301','2216619736664300','2216619736664302','2216619736664337',
	'2216658391272582','2216658391272586','2216658391272584','2216658391272588','2215558879644321','2216658391272515',
	'2216658391272583','2216658391272585','2216658391272587','2216658391272589','2216658391272590','2215558879644322',
	'2215558879644415','2215558879644420','2216658391272517','2215558879644320','2216619736664606','2216619736664772',
	'2216619736664817','11','3138940102705152','3139047476887552','3139141227970560','3202928538746880','2216619736663966',
	'3202928538746880','3249713281957888')
)

#online环境执行此sql
update t_order set is_dock = 1 where transaction_id in (

	SELECT DISTINCT transaction_id FROM `t_order_merch` WHERE `product_id` in 
	('2216619736663733','2216619736663732','2216619736663957','2216619736663958','2216619736663956','2216619736663960',
	'2216619736664003','2216619736664003','2216619736664002','2216619736664002','2216619736664000','2216619736664000',
	'2216619736663998','2216619736663998','2216619736663997','2216619736663997','2216619736663994','2216619736663994',
	'2216619736663993','2216619736663993','2216619736663991','2216619736664015','2216619736664015','2216619736664014',
	'2216619736664014','2216619736664013','2216619736664011','2216619736664011','2216619736664006','2216619736664006',
	'2216619736664005','2216619736664005','2216619736664050','2216619736664050','2216619736664049','2216619736664049',
	'2216619736664048','2216619736664048','2216619736664047','2216619736664047','2216619736664046','2216619736664046',
	'2216619736664045','2216619736664045','2216619736664051','2216619736664051','2216619736663984','2216619736663985',
	'2216619736664148','2216619736664158','2216619736664162','2216619736664163','2216619736664164','2216619736664168',
	'2216619736664169','2216619736664167','2216619736664165','2216619736664171','2216619736664170','2216619736664170',
	'2216619736664149','2216619736664150','2216619736664151','2216619736664152','2216619736664153','2216619736664154',
	'2216619736664184','2216619736664185','2216619736664166','2216619736664166','2216619736663999','2216619736663996',
	'2216619736664213','2216619736664208','2216619736664209','2216619736664226','2216619736664227','2216619736664217',
	'2216619736664216','2216619736664206','2216619736664207','2216619736664204','2216619736664203','2216619736664215',
	'2216619736664218','2216619736664224','2216619736664225','2216619736664267','2216619736664228','2216619736664297',
	'2216619736664280','2216619736664278','2216619736664281','2216619736664279','2216619736664285','2216619736664274',
	'2216619736664286','2216619736664273','2216619736664271','2216619736664288','2216619736664287','2216619736664275',
	'2216619736664284','2216619736664291','2216619736664292','2216619736664293','2216619736664289','2216619736664294',
	'2216619736664290','2216619736664272','2216619736664301','2216619736664300','2216619736664302','2216619736664337',
	'2216658391272582','2216658391272586','2216658391272584','2216658391272588','2215558879644321','2216658391272515',
	'2216658391272583','2216658391272585','2216658391272587','2216658391272589','2216658391272590','2215558879644322',
	'2215558879644415','2215558879644420','2216658391272517','2215558879644320','999','2216619736665494',
	'2216619736665465','2216619736665464','2216619736664145','2215558879644414','2216658391272578','2216658391272580',
	'2216658391272606','2216658391272607','2215558879644421','2215558879644416','2216658391272579','2216658391272581',
	'2216658391272608','2216619736665395','2216619736665396','2216619736665397','2216619736665398','2216619736665560',
	'2216619736665559','2216619736665558','2216619736665557','2216619736665556','2216619736665555','2216619736665554',
	'2216619736665533','2216619736665648','2216619736665796','2216619736665858','2216619736665856','2216619736665855',
	'2216619736665854','2216619736665852','2216619736665849','2216619736666049','2216619736666049','2216619736665542',
	'2216619736665797','2216619736665659','2216619736665658','2216619736665657','2216619736665656','2216619736665655',
	'2216619736665653','2216619736665651','2216619736665650','2216619736665649','2216619736665543','2216619736665541',
	'2216619736665539','2216619736665538','2216619736665540','2216619736666059','2216619736666057','3046762547445760',
	'3051782856245248','3046733355089920','3046718888476672','3096740087988224','3096775016841216','3096936720302080',
	'3096953963937792','3097008724770816','3097055301664768','3097219513712640','3097238873309184','3097253675466752',
	'3097255081410560','3097314370781184','3097055301664768','3121766222790656','3172340303659008','3172738599747584',
	'3185344134184960','3185331242532864','3185320634351616')
	
)


DROP TABLE `tbl_biz_trading_record_copy`;
DROP TABLE `tbl_biz_trading_record_copy_copy`;
